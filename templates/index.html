<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wikidle</title>
    <!-- Linux Libertine Font via Google Fonts (Cormorant Garamond) -->
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>

<body>
    <h1>Wikidle</h1>
    <div class="grid" id="grid"></div>

    <input type="text" id="guess" maxlength="5" autocomplete="off" oninput="validateInput()" onkeydown="if(event.key === 'Enter') checkGuess()">
    <button id="submit-button" onclick="checkGuess()" disabled>Submit Guess</button>

    <div class="feedback-container">
        <p><span class="dot red"></span> <span id="red-letters"></span></p>
        <p><span class="dot orange"></span> <span id="orange-letters"></span></p>
        <p><span class="dot green"></span> <span id="green-letters"></span></p>
    </div>

    <div id="wiki-embed-container"></div>

    <p class="legend">
        <span class="dot green"></span> Green: correct letter in the correct place<br>
        <span class="dot orange"></span> Orange: correct letter but wrong place<br>
        <span class="dot red"></span> Red: wrong letter
    </p>

    <script>
        let wordOfTheDay = "";
        let validWords = [];
        let persistentRedLetters = new Set();

        // Fetch the word of the day from the backend
        fetch("/get_word")
            .then(response => response.json())
            .then(data => {
                wordOfTheDay = data.word;
                console.log("DEBUG: The correct word is:", wordOfTheDay);
            });

        // Fetch the list of valid words
        fetch("/get_word_list")
            .then(response => response.json())
            .then(data => {
                validWords = data.words;
            });

        // Validate the input and enable/disable the submit button
        function validateInput() {
            const guess = document.getElementById("guess").value.toLowerCase();
            const submitButton = document.getElementById("submit-button");
            if (validWords.includes(guess) && guess.length === 5) {
                submitButton.disabled = false;
            } else {
                submitButton.disabled = true;
            }
        }

        function checkGuess() {
            const guess = document.getElementById("guess").value.toLowerCase();

            const grid = document.getElementById("grid");
            grid.innerHTML = "";  // Clear the grid for new guess

            let redLetters = new Set();
            let orangeLetters = new Set();
            let greenLetters = new Set();

            for (let i = 0; i < 5; i++) {
                const cell = document.createElement("div");
                cell.className = "cell";
                cell.textContent = guess[i].toUpperCase();

                if (guess[i] === wordOfTheDay[i]) {
                    cell.classList.add("correct");
                    greenLetters.add(guess[i].toUpperCase());
                } else if (wordOfTheDay.includes(guess[i])) {
                    cell.classList.add("misplaced");
                    orangeLetters.add(guess[i].toUpperCase());
                } else {
                    cell.classList.add("wrong");
                    persistentRedLetters.add(guess[i].toUpperCase());
                    redLetters.add(guess[i].toUpperCase());
                }

                grid.appendChild(cell);
            }

            document.getElementById("red-letters").textContent = Array.from(persistentRedLetters).join(", ");
            document.getElementById("orange-letters").textContent = Array.from(orangeLetters).join(", ");
            document.getElementById("green-letters").textContent = Array.from(greenLetters).join(", ");

            // Clear the input box and disable the button
            document.getElementById("guess").value = "";
            document.getElementById("submit-button").disabled = true;

            // If the guess is correct, embed the Wikipedia page
            if (guess === wordOfTheDay) {
                embedWikipediaPage(wordOfTheDay);
            }
        }

        function embedWikipediaPage(word) {
            const wikiContainer = document.getElementById("wiki-embed-container");
            const wikiUrl = `https://en.wikipedia.org/wiki/${encodeURIComponent(word)}`;
            wikiContainer.innerHTML = `
                <h2>Learn More About "${word}"</h2>
                <iframe src="${wikiUrl}" width="100%" height="500px" style="border: none;"></iframe>
            `;
        }
    </script>
</body>
</html>
